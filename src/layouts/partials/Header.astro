---
import Buttons from '../components/Buttons/Buttons.astro';
import Logo from '../components/Logo.astro';
---

<header class='header header__text'>
  <nav class='navigation' aria-label='Men√∫ principal'>
    <div class='navigation__container'>
      <!-- Logo -->
      <div class='navigation__container-logo'>
        <Logo />
      </div>

      <!-- Bot√≥n hamburguesa (m√≥vil) -->
      <button
        id='nav-toggle'
        class='navigation__container-button navigation__container-button--open'
        aria-expanded='false'
        aria-controls='nav-menu'
        aria-label='Abrir men√∫'
        type='button'
      >
        <svg class='navigation__container-button-icon' viewBox='0 0 20 20'>
          <title>Abrir men√∫</title>
          <path d='M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z'></path>
        </svg>
      </button>

      <!-- Men√∫ principal -->
      <ul id='nav-menu' class='navigation__container-menu' aria-hidden='true' hidden>
        <!-- Bot√≥n cerrar dentro del men√∫ m√≥vil -->
        <li class='navigation__container-menu-item navigation__container-menu-item-close'>
          <button
            class='navigation__container-button navigation__container-button--close'
            aria-label='Cerrar men√∫'
            type='button'
            id='close-menu'
          >
            <svg class='navigation__container-button-icon' viewBox='0 0 20 20'>
              <title>Cerrar men√∫</title>
              <polygon
                points='11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2'
                transform='rotate(45 10 10)'></polygon>
            </svg>
          </button>
        </li>

        <!-- Mega men√∫ -->
        <li class='navigation__container-menu-itemsMap'>
          <button
            id='services-btn'
            class='navigation__container-menu-itemsMap-link'
            aria-expanded='false'
            aria-controls='submenu-services'
            type='button'
          >
            Servicios
            <svg
              id='services-arrow'
              class='navigation__container-menu-itemsMap-arrow'
              viewBox='0 0 20 20'
              xmlns='http://www.w3.org/2000/svg'
            >
              <path d='M5 7l5 5 5-5H5z'></path>
            </svg>
          </button>

          <div id='submenu-services' class='navigation__container-megamenu' aria-hidden='true' hidden>
            <div class='megamenu-column'>
              <h3><a href='/servicios/diseno-web/'>Dise√±o y desarrollo web</a></h3>
              <ul>
                <li><a href='/servicios/web-corporativa/'>Web corporativa</a></li>
                <li><a href='/servicios/tienda-online/'>Tienda online / e-commerce</a></li>
                <li><a href='/servicios/landing-page/'>Landing pages</a></li>
                <li><a href='/servicios/redisenio-web/'>Redise√±o web</a></li>
              </ul>
            </div>
            <div class='megamenu-column'>
              <h3><a href='/servicios/funcionalidades-optimizacion-web/'>Funcionalidades y Optimizaci√≥n</a></h3>
              <ul>
                <li><a href='/servicios/web-multilingue/'>Web multiling√ºe</a></li>
                <li><a href='/servicios/sistemas-de-reservas/'>Sistemas de reservas</a></li>
                <li><a href='/servicios/accesibilidad-web/'>Accesibilidad web</a></li>
                <li><a href='/servicios/cartas-digitales-restaurantes/'>Cartas digitales para restaurantes</a></li>
              </ul>
            </div>
            <div class='megamenu-column'>
              <h3>Mantenimiento y soporte</h3>
              <ul>
                <li><a href='/servicios/mantenimiento-web/'>Mantenimiento web</a></li>
                <li><a href='/servicios/hosting-dominio/'>Hosting y dominio</a></li>
              </ul>
            </div>
          </div>
        </li>

        <li class='navigation__container-menu-itemsMap'>
          <a href='/sobre-nosotras/' class='navigation__container-menu-itemsMap-link'>Astracodelab</a>
        </li>

        <li class='navigation__container-menu-itemsMap'>
          <a href='/contacto/' class='navigation__container-menu-itemsMap-link'>Contacto</a>
        </li>

        <li class='navigation__container-menu-itemsMap cta-mobile'>
          <Buttons
            href='https://wa.me/34623752940'
            target='_blank'
            rel='noopener noreferrer'
            className='btnPrimaryLight'>¬øHablamos?</Buttons
          >
        </li>
      </ul>

      <div class='button-header'>
        <Buttons href='https://wa.me/34623752940' target='_blank' rel='noopener noreferrer' className='btnPrimaryLight'
          >¬øHablamos?</Buttons
        >
      </div>
    </div>
  </nav>
</header>

<script is:inline>
  // Esperar a que el DOM est√© listo y tambi√©n a las transiciones de Astro
  function initializeNavigation() {
    console.log('üîÑ Inicializando navegaci√≥n...');

    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu');
    const closeBtn = document.getElementById('close-menu');
    const servicesBtn = document.getElementById('services-btn');
    const submenu = document.getElementById('submenu-services');
    const arrowIcon = document.getElementById('services-arrow');

    if (!navToggle || !navMenu || !servicesBtn || !submenu) {
      console.error('‚ùå No se encontraron elementos del men√∫');
      return;
    }

    let isMenuOpen = false;
    let isSubmenuOpen = false;

    // Funci√≥n para toggle del men√∫ m√≥vil
    const toggleMenu = (open) => {
      isMenuOpen = open;
      const expanded = open ? 'true' : 'false';
      navToggle.setAttribute('aria-expanded', expanded);
      navMenu.setAttribute('aria-hidden', open ? 'false' : 'true');

      // Usar atributo hidden para prevenir enfoque en elementos ocultos
      if (open) {
        navMenu.removeAttribute('hidden');
      } else {
        navMenu.setAttribute('hidden', '');
      }
    };

    navToggle.addEventListener('click', () => {
      const isOpen = navToggle.getAttribute('aria-expanded') === 'true';
      toggleMenu(!isOpen);
    });

    closeBtn.addEventListener('click', () => {
      toggleMenu(false);
    });

    // Controlar men√∫ m√≥vil con teclado
    navToggle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        navToggle.click();
      }
    });

    // Funci√≥n para toggle del submen√∫ de servicios
    const toggleSubmenu = (open) => {
      isSubmenuOpen = open;
      const expanded = open ? 'true' : 'false';
      servicesBtn.setAttribute('aria-expanded', expanded);
      submenu.setAttribute('aria-hidden', open ? 'false' : 'true');
      if (arrowIcon) {
        arrowIcon.style.transform = open ? 'rotate(180deg)' : 'rotate(0deg)';
      }

      // Usar atributo hidden para prevenir enfoque en elementos ocultos
      if (open) {
        submenu.removeAttribute('hidden');
      } else {
        submenu.setAttribute('hidden', '');
      }
    };

    servicesBtn.addEventListener('click', () => {
      const isOpen = servicesBtn.getAttribute('aria-expanded') === 'true';
      toggleSubmenu(!isOpen);
    });

    servicesBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        toggleSubmenu(!isSubmenuOpen);
      }
    }, true);

    // Cerrar men√∫s al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (isMenuOpen && !navMenu.contains(e.target) && !navToggle.contains(e.target)) {
        console.log('üëÜ Click fuera - cerrando men√∫');
        toggleMenu(false);
      }

      if (isSubmenuOpen && !servicesBtn.contains(e.target) && !submenu.contains(e.target)) {
        console.log('üëÜ Click fuera - cerrando submen√∫');
        toggleSubmenu(false);
      }
    });

    // Cerrar men√∫s al hacer clic en enlaces (para navegaci√≥n)
    const navLinks = navMenu.querySelectorAll('a[href^="/"]');
    navLinks.forEach((link) => {
      link.addEventListener('click', () => {
        console.log('üîó Click en enlace - cerrando men√∫s');
        toggleMenu(false);
        toggleSubmenu(false);
      });
    });

    // Cerrar con tecla Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (isSubmenuOpen) {
          toggleSubmenu(false);
        } else if (isMenuOpen) {
          toggleMenu(false);
        }
      }
    });

    console.log('‚úÖ Navegaci√≥n inicializada correctamente');
  }

  // Inicializar cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeNavigation);
  } else {
    initializeNavigation();
  }

  // Re-inicializar despu√©s de las transiciones de Astro
  document.addEventListener('astro:page-load', initializeNavigation);
  document.addEventListener('astro:after-swap', initializeNavigation);

  // Tambi√©n inicializar despu√©s de un timeout por si acaso
  setTimeout(initializeNavigation, 100);
</script>
